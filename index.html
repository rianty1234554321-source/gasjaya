<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Timbangan Gas Jaya - Sistem Pencatatan</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <style>
        /* [Copy semua CSS dari website Anda yang sekarang] */
        /* Tambahkan: */
        .table-responsive { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; font-size: 0.875rem; }
        th, td { padding: 0.75rem; text-align: left; border-bottom: 1px solid #e2e8f0; }
        th { background: #f1f5f9; font-weight: 600; }
        tr:hover { background: #f8fafc; }
        .badge { padding: 0.25rem 0.5rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 600; }
        .badge-success { background: #d1fae5; color: #065f46; }
        .badge-warning { background: #fef3c7; color: #92400e; }
        .btn-sm { padding: 0.375rem 0.75rem; font-size: 0.875rem; }
        .action-btns { display: flex; gap: 0.25rem; }
        
        @media print {
            .no-print { display: none !important; }
            body { font-size: 12pt; }
        }
    </style>
</head>
<body>
    <!-- [Copy header dan form Anda yang sekarang] -->
    
    <!-- TAMBAHKAN INI: -->
    <div class="container" style="margin-top: 2rem;">
        <!-- Quick Stats -->
        <div class="stats-grid" style="margin-bottom: 1.5rem;">
            <div class="stat-card">
                <div class="stat-label">Total Transaksi</div>
                <div class="stat-value" id="stat-total">0</div>
            </div>
            <div class="stat-card" style="border-left-color: #10b981;">
                <div class="stat-label">Total Berat</div>
                <div class="stat-value"><span id="stat-berat">0</span> kg</div>
            </div>
            <div class="stat-card" style="border-left-color: #f59e0b;">
                <div class="stat-label">Total Nilai</div>
                <div class="stat-value">Rp <span id="stat-nilai">0</span></div>
            </div>
        </div>

        <!-- Riwayat -->
        <div class="card">
            <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
                <h2 class="card-title">üìã Riwayat Transaksi</h2>
                <div>
                    <button onclick="document.getElementById('import-section').scrollIntoView()" class="btn btn-secondary btn-sm">Import CSV</button>
                    <button onclick="exportCSV()" class="btn btn-success btn-sm" style="margin-left: 0.5rem;">Export CSV</button>
                </div>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table id="tabel-riwayat">
                        <thead>
                            <tr>
                                <th>Tanggal</th>
                                <th>Supir</th>
                                <th>Plat</th>
                                <th>Supplier</th>
                                <th>Berat Bersih</th>
                                <th>Total</th>
                                <th>Status</th>
                                <th>Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="tbody-riwayat">
                            <tr>
                                <td colspan="8" style="text-align: center; padding: 2rem; color: #64748b;">
                                    Belum ada transaksi tersimpan
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Import Section -->
        <div id="import-section" class="card" style="margin-top: 1.5rem;">
            <div class="card-header">
                <h2 class="card-title">üìÅ Import/Export Data</h2>
            </div>
            <div class="card-body">
                <div style="display: grid; gap: 1rem; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));">
                    <div>
                        <h4 style="margin-bottom: 0.5rem;">Import dari CSV</h4>
                        <input type="file" id="csv-file" accept=".csv" onchange="importCSV(this)" style="display: none;">
                        <button onclick="document.getElementById('csv-file').click()" class="btn btn-secondary">
                            üì§ Upload CSV
                        </button>
                        <button onclick="downloadTemplate()" class="btn btn-outline btn-sm">Template</button>
                    </div>
                    <div>
                        <h4 style="margin-bottom: 0.5rem;">Backup Data</h4>
                        <button onclick="backupJSON()" class="btn btn-success">üíæ Backup JSON</button>
                        <input type="file" id="restore-file" accept=".json" onchange="restoreJSON(this)" style="display: none;">
                        <button onclick="document.getElementById('restore-file').click()" class="btn btn-warning btn-sm">Restore</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Nota -->
    <div id="modal-nota" class="no-print" style="display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
        <div style="background: white; padding: 2rem; border-radius: 0.5rem; max-width: 400px; width: 90%; max-height: 90vh; overflow-y: auto;">
            <div id="nota-isi" style="font-family: 'Courier New', monospace; font-size: 12px; line-height: 1.4;">
                <!-- Nota content -->
            </div>
            <div style="margin-top: 1rem; display: flex; gap: 0.5rem; justify-content: flex-end;">
                <button onclick="document.getElementById('modal-nota').style.display='none'" class="btn btn-outline">Tutup</button>
                <button onclick="window.print()" class="btn btn-primary">üñ®Ô∏è Cetak Nota</button>
            </div>
        </div>
    </div>

    <script>
        // Storage
        const DB = {
            key: 'gasjaya_v1',
            get: () => JSON.parse(localStorage.getItem(this.key) || '[]'),
            set: (data) => localStorage.setItem(this.key, JSON.stringify(data))
        };

        // Modifikasi fungsi simpan Anda yang sudah ada:
        function simpanTransaksi(e) {
            e.preventDefault();
            
            // [Kode perhitungan Anda yang sudah ada...]
            
            const transaksi = {
                id: Date.now(),
                tanggal: document.getElementById('tanggal').value,
                jam: document.getElementById('jam').value,
                supir: document.getElementById('nama-supir').value,
                plat: document.getElementById('plat-nomor').value,
                supplier: document.getElementById('nama-supplier').value,
                bruto: parseFloat(document.getElementById('berat-kotor').value) || 0,
                tara: parseFloat(document.getElementById('tara').value) || 0,
                potonganPersen: parseFloat(document.getElementById('potongan-persen').value) || 0,
                potonganKg: parseFloat(document.getElementById('potongan-kg').value) || 0,
                netto: parseFloat(document.getElementById('berat-bersih').textContent) || 0,
                harga: parseFloat(document.getElementById('harga-per-kg').value) || 0,
                admin: parseFloat(document.getElementById('biaya-admin').value) || 0,
                total: parseFloat(document.getElementById('total-transfer').textContent.replace(/\D/g,'')) || 0,
                status: document.getElementById('status').value,
                dibayar: parseFloat(document.getElementById('jumlah-dibayar')?.value) || 0,
                sisa: parseFloat(document.getElementById('terutang')?.value) || 0
            };

            const data = DB.get();
            data.unshift(transaksi);
            DB.set(data);

            alert('‚úÖ Transaksi berhasil disimpan!');
            
            // Tanya cetak nota
            if(confirm('Cetak nota sekarang?')) {
                cetakNota(transaksi.id);
            }
            
            updateTampilan();
            // Reset form jika perlu
        }

        function updateTampilan() {
            const data = DB.get();
            
            // Update stats
            document.getElementById('stat-total').textContent = data.length;
            document.getElementById('stat-berat').textContent = data.reduce((a,b) => a + (b.netto || 0), 0).toFixed(2);
            document.getElementById('stat-nilai').textContent = (data.reduce((a,b) => a + (b.total || 0), 0) / 1000000).toFixed(1) + 'M';
            
            // Update tabel
            const tbody = document.getElementById('tbody-riwayat');
            if (data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 2rem; color: #64748b;">Belum ada transaksi</td></tr>';
                return;
            }
            
            tbody.innerHTML = data.map(t => `
                <tr>
                    <td>${t.tanggal}<br><small>${t.jam}</small></td>
                    <td>${t.supir}</td>
                    <td>${t.plat}</td>
                    <td>${t.supplier}</td>
                    <td>${t.netto?.toFixed(2)} kg</td>
                    <td>Rp ${t.total?.toLocaleString('id-ID')}</td>
                    <td><span class="badge ${t.status === 'Lunas' ? 'badge-success' : 'badge-warning'}">${t.status}</span></td>
                    <td class="action-btns">
                        <button onclick="cetakNota(${t.id})" class="btn btn-primary btn-sm" title="Cetak">üñ®Ô∏è</button>
                        <button onclick="hapusTrans(${t.id})" class="btn btn-danger btn-sm" title="Hapus">üóëÔ∏è</button>
                    </td>
                </tr>
            `).join('');
        }

        function cetakNota(id) {
            const t = DB.get().find(x => x.id === id);
            if (!t) return;
            
            document.getElementById('nota-isi').innerHTML = `
                <div style="text-align: center; border-bottom: 2px solid #000; padding-bottom: 10px; margin-bottom: 10px;">
                    <div style="font-size: 16px; font-weight: bold;">TIMBANGAN GAS JAYA</div>
                    <div style="font-size: 10px;">Jl. Industri No. 123, Jakarta</div>
                    <div style="font-size: 10px;">Telp: 021-1234567</div>
                </div>
                
                <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                    <span>No:</span><span>TRX-${String(t.id).slice(-6)}</span>
                </div>
                <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                    <span>Tgl:</span><span>${t.tanggal} ${t.jam}</span>
                </div>
                <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                    <span>Supir:</span><span>${t.supir}</span>
                </div>
                <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                    <span>Plat:</span><span>${t.plat}</span>
                </div>
                
                <div style="border-top: 1px dashed #000; border-bottom: 1px dashed #000; margin: 10px 0; padding: 5px 0;">
                    <div style="display: flex; justify-content: space-between;">
                        <span>Bruto:</span><span>${t.bruto} kg</span>
                    </div>
                    <div style="display: flex; justify-content: space-between;">
                        <span>Tara:</span><span>${t.tara} kg</span>
                    </div>
                    <div style="display: flex; justify-content: space-between;">
                        <span>Potongan:</span><span>${t.potonganPersen}%</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; font-weight: bold;">
                        <span>Netto:</span><span>${t.netto} kg</span>
                    </div>
                </div>
                
                <div style="display: flex; justify-content: space-between;">
                    <span>Harga/kg:</span><span>Rp ${t.harga?.toLocaleString('id-ID')}</span>
                </div>
                <div style="display: flex; justify-content: space-between; font-size: 14px; font-weight: bold; border-top: 2px solid #000; margin-top: 5px; padding-top: 5px;">
                    <span>TOTAL:</span><span>Rp ${t.total?.toLocaleString('id-ID')}</span>
                </div>
                <div style="display: flex; justify-content: space-between; margin-top: 5px;">
                    <span>Status:</span><span>${t.status}</span>
                </div>
                
                <div style="margin-top: 30px; display: flex; justify-content: space-between; font-size: 10px;">
                    <div style="text-align: center; width: 40%;">
                        <div style="border-top: 1px solid #000; margin-top: 30px;">Operator</div>
                    </div>
                    <div style="text-align: center; width: 40%;">
                        <div style="border-top: 1px solid #000; margin-top: 30px;">Supir</div>
                    </div>
                </div>
                
                <div style="text-align: center; margin-top: 20px; font-size: 9px;">
                    Terima kasih atas kepercayaan Anda<br>
                    Nota ini sah tanpa tanda tangan basah
                </div>
            `;
            
            document.getElementById('modal-nota').style.display = 'flex';
        }

        function hapusTrans(id) {
            if (!confirm('Hapus transaksi ini?')) return;
            const data = DB.get().filter(t => t.id !== id);
            DB.set(data);
            updateTampilan();
        }

        function exportCSV() {
            const data = DB.get();
            if (!data.length) return alert('Tidak ada data!');
            
            const csv = Papa.unparse(data);
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `transaksi_gasjaya_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
        }

        function importCSV(input) {
            const file = input.files[0];
            Papa.parse(file, {
                header: true,
                complete: (results) => {
                    const data = DB.get();
                    results.data.forEach(row => {
                        if (row.supir || row.nama_supir) {
                            const netto = (parseFloat(row.bruto || row.berat_kotor) || 0) - (parseFloat(row.tara) || 0) - ((parseFloat(row.potongan || row.potonganPersen) || 0) / 100);
                            data.push({
                                id: Date.now() + Math.random(),
                                ...row,
                                netto: netto,
                                total: (netto * (parseFloat(row.harga || row.harga_per_kg) || 0)) + (parseFloat(row.admin || row.biaya_admin) || 0)
                            });
                        }
                    });
                    DB.set(data);
                    updateTampilan();
                    alert('Import berhasil!');
                }
            });
        }

        function downloadTemplate() {
            const csv = 'tanggal,jam,supir,nama_supir,plat,plat_nomor,supplier,nama_supplier,bruto,berat_kotor,tara,potongan,potonganPersen,harga,harga_per_kg,admin,biaya_admin,status\n';
            const row = '2024-01-15,08:30,Budi Santono,Budi Santono,B 1234 ABC,B 1234 ABC,PT Gas Makmur,PT Gas Makmur,5000,5000,1500,2,2,8500,8500,50000,50000,Lunas\n';
            const blob = new Blob([csv + row], { type: 'text/csv' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'template_gasjaya.csv';
            a.click();
        }

        function backupJSON() {
            const data = DB.get();
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `backup_gasjaya_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
        }

        function restoreJSON(input) {
            const file = input.files[0];
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    if (Array.isArray(data)) {
                        DB.set(data);
                        updateTampilan();
                        alert('Restore berhasil!');
                    }
                } catch (err) {
                    alert('File tidak valid!');
                }
            };
            reader.readAsText(file);
        }

        // Init
        document.addEventListener('DOMContentLoaded', updateTampilan);
    </script>
</body>
</html>
