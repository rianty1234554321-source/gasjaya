<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0">
    <title>Timbangan Gas Jaya</title>
    <meta name="theme-color" content="#2563eb">
    <link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoiVGltYmFuZ2FuIEdhcyBKYXlhIiwic2hvcnRfbmFtZSI6Ikdhc0pheWEiLCJzdGFydF91cmwiOiIuIiwiZGlzcGxheSI6InN0YW5kYWxvbmUiLCJiYWNrZ3JvdW5kX2NvbG9yIjoiI2ZmZmZmZiIsInRoZW1lX2NvbG9yIjoiIzI1NjNlYiJ9">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <style>
        *{margin:0;padding:0;box-sizing:border-box}
        :root{--primary:#2563eb;--success:#10b981;--warning:#f59e0b;--danger:#ef4444;--bg:#f8fafc;--card:#fff;--text:#1e293b;--border:#e2e8f0}
        body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:var(--bg);color:var(--text);line-height:1.5}
        .header{background:linear-gradient(135deg,var(--primary)0%,#1d4ed8 100%);color:#fff;padding:1rem;position:sticky;top:0;z-index:100}
        .container{max-width:1400px;margin:0 auto;padding:1rem}
        .nav{display:flex;gap:0.5rem;overflow-x:auto;padding:1rem 0}
        .nav-btn{padding:0.5rem 1rem;background:rgba(255,255,255,0.1);border:none;color:#fff;border-radius:0.5rem;cursor:pointer;white-space:nowrap}
        .nav-btn.active{background:#fff;color:var(--primary)}
        .card{background:var(--card);border-radius:0.75rem;box-shadow:0 1px 3px rgba(0,0,0,0.1);margin-bottom:1rem;overflow:hidden}
        .card-header{padding:1rem;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center}
        .card-body{padding:1rem}
        .stats{display:grid;grid-template-columns:repeat(2,1fr);gap:0.75rem;margin-bottom:1rem}
        .stat{background:#fff;padding:1rem;border-radius:0.5rem;border-left:4px solid var(--primary);box-shadow:0 1px 3px rgba(0,0,0,0.1)}
        .stat.success{border-left-color:var(--success)}
        .stat.warning{border-left-color:var(--warning)}
        .stat-value{font-size:1.25rem;font-weight:700}
        .form-grid{display:grid;grid-template-columns:1fr;gap:0.75rem}
        .form-group{margin-bottom:0.5rem}
        .form-label{display:block;font-size:0.875rem;font-weight:500;margin-bottom:0.25rem}
        .form-input,.form-select{width:100%;padding:0.75rem;border:1px solid var(--border);border-radius:0.5rem;font-size:16px}
        .input-group{display:flex}
        .input-prefix,.input-suffix{padding:0.75rem;background:var(--bg);border:1px solid var(--border);font-size:0.875rem}
        .input-prefix{border-radius:0.5rem 0 0 0.5rem;border-right:none}
        .input-suffix{border-radius:0 0.5rem 0.5rem 0;border-left:none}
        .input-group .form-input{border-radius:0;flex:1}
        .btn{padding:0.75rem 1rem;border:none;border-radius:0.5rem;font-size:0.9375rem;font-weight:500;cursor:pointer;display:inline-flex;align-items:center;gap:0.5rem;min-height:44px}
        .btn-primary{background:var(--primary);color:#fff}
        .btn-success{background:var(--success);color:#fff}
        .btn-outline{border:1px solid var(--border);background:#fff}
        .calc-box{background:#f0f9ff;border:1px solid #e0f2fe;border-radius:0.5rem;padding:1rem;margin:1rem 0}
        .calc-row{display:flex;justify-content:space-between;padding:0.5rem 0;border-bottom:1px dashed #cbd5e1}
        .calc-row:last-child{border:none;font-weight:700;color:var(--primary);font-size:1.125rem;border-top:2px solid #bfdbfe;margin-top:0.5rem;padding-top:0.5rem}
        .table-container{overflow-x:auto;-webkit-overflow-scrolling:touch;margin:0 -1rem;padding:0 1rem}
        table{width:100%;border-collapse:collapse;font-size:0.875rem;min-width:800px}
        th,td{padding:0.75rem;text-align:left;border-bottom:1px solid var(--border)}
        th{background:#f1f5f9;font-weight:600;font-size:0.75rem;text-transform:uppercase;color:#64748b}
        .badge{padding:0.25rem 0.5rem;border-radius:9999px;font-size:0.75rem;font-weight:600}
        .badge-success{background:#d1fae5;color:#065f46}
        .badge-warning{background:#fef3c7;color:#92400e}
        .upload-zone{border:2px dashed var(--border);border-radius:0.5rem;padding:2rem;text-align:center;cursor:pointer;background:var(--bg)}
        .upload-zone:hover{border-color:var(--primary);background:#f0f9ff}
        .modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.5);z-index:1000;align-items:center;justify-content:center;padding:1rem}
        .modal.show{display:flex}
        .modal-content{background:#fff;border-radius:1rem;max-width:500px;width:100%;max-height:90vh;overflow:hidden}
        .modal-header{padding:1rem;border-bottom:1px solid var(--border);display:flex;justify-content:space-between}
        .modal-body{padding:1rem;overflow-y:auto}
        .modal-footer{padding:1rem;border-top:1px solid var(--border);display:flex;justify-content:flex-end;gap:0.5rem;background:#f8fafc}
        .nota{font-family:'Courier New',monospace;font-size:12px;line-height:1.4;padding:1rem}
        .nota-header{text-align:center;border-bottom:2px solid #000;padding-bottom:0.5rem;margin-bottom:0.5rem}
        .nota-title{font-size:16px;font-weight:bold}
        .nota-row{display:flex;justify-content:space-between;padding:0.125rem 0}
        .nota-total{font-size:14px;font-weight:bold;border-top:2px solid #000;margin-top:0.5rem;padding-top:0.5rem}
        .empty{text-align:center;padding:3rem;color:#64748b}
        .toast{position:fixed;bottom:1rem;right:1rem;background:#fff;padding:1rem;border-radius:0.5rem;box-shadow:0 10px 15px rgba(0,0,0,0.1);border-left:4px solid var(--success);z-index:10000;display:none;animation:slideIn 0.3s ease}
        @keyframes slideIn{from{transform:translateX(100%)}to{transform:translateX(0)}}
        .toast.show{display:block}
        .offline{position:fixed;top:0;left:0;right:0;background:var(--warning);color:#fff;padding:0.5rem;text-align:center;z-index:9999;display:none}
        .offline.show{display:block}
        @media(min-width:768px){
            .stats{grid-template-columns:repeat(4,1fr)}
            .form-grid{grid-template-columns:repeat(2,1fr)}
            .span-2{grid-column:span 2}
        }
        @media print{
            body *{visibility:hidden}
            .nota,.nota *{visibility:visible}
            .nota{position:absolute;left:0;top:0;width:80mm;padding:5mm}
            .no-print{display:none!important}
        }
    </style>
</head>
<body>
    <div class="offline" id="offline">üì° Anda offline - Data tersimpan lokal</div>
    <div class="toast" id="toast">‚úÖ Berhasil!</div>
    
    <header class="header">
        <div class="container">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem">
                <div>
                    <h1>‚öñÔ∏è Timbangan Gas Jaya</h1>
                    <p style="font-size:0.875rem;opacity:0.9">Sistem Pencatatan Online & Offline</p>
                </div>
                <div id="status" style="font-size:0.75rem;padding:0.25rem 0.75rem;background:rgba(255,255,255,0.2);border-radius:9999px">üü¢ Online</div>
            </div>
            <nav class="nav">
                <button class="nav-btn active" onclick="switchTab('dashboard')">üìä Dashboard</button>
                <button class="nav-btn" onclick="switchTab('input')">üìù Input</button>
                <button class="nav-btn" onclick="switchTab('riwayat')">üìã Riwayat</button>
                <button class="nav-btn" onclick="switchTab('data')">üíæ Data</button>
            </nav>
        </div>
    </header>

    <main class="container">
        <!-- Dashboard -->
        <section id="dashboard" class="tab-content" style="display:block">
            <div class="stats">
                <div class="stat">
                    <div style="font-size:0.75rem;color:#64748b">Total Transaksi</div>
                    <div class="stat-value" id="stat-total">0</div>
                </div>
                <div class="stat success">
                    <div style="font-size:0.75rem;color:#64748b">Total Berat</div>
                    <div class="stat-value"><span id="stat-berat">0</span> kg</div>
                </div>
                <div class="stat warning">
                    <div style="font-size:0.75rem;color:#64748b">Total Nilai</div>
                    <div class="stat-value">Rp <span id="stat-nilai">0</span></div>
                </div>
                <div class="stat" style="border-left-color:#ef4444">
                    <div style="font-size:0.75rem;color:#64748b">Belum Lunas</div>
                    <div class="stat-value" id="stat-pending">0</div>
                </div>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <h3>üïê Transaksi Terbaru</h3>
                    <button class="btn btn-outline" onclick="switchTab('riwayat')">Lihat Semua</button>
                </div>
                <div class="card-body" id="recent-list">
                    <div class="empty">Belum ada transaksi</div>
                </div>
            </div>
        </section>

        <!-- Input -->
        <section id="input" class="tab-content" style="display:none">
            <form onsubmit="saveData(event)">
                <div class="card">
                    <div class="card-header">
                        <h3>üìù Input Timbangan Baru</h3>
                        <button type="button" class="btn btn-outline" onclick="resetForm()">Reset</button>
                    </div>
                    <div class="card-body">
                        <div class="form-grid">
                            <div class="form-group">
                                <label class="form-label">Tanggal *</label>
                                <input type="date" class="form-input" id="f-tgl" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Jam *</label>
                                <input type="time" class="form-input" id="f-jam" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Nama Supir *</label>
                                <input type="text" class="form-input" id="f-supir" placeholder="Nama supir" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Plat Nomor *</label>
                                <input type="text" class="form-input" id="f-plat" placeholder="B 1234 ABC" required>
                            </div>
                            <div class="form-group span-2">
                                <label class="form-label">Supplier *</label>
                                <input type="text" class="form-input" id="f-supplier" placeholder="Nama supplier" required>
                            </div>
                        </div>

                        <h4 style="margin:1rem 0 0.5rem;font-size:0.875rem;color:#64748b">‚öñÔ∏è Perhitungan Berat</h4>
                        <div class="form-grid">
                            <div class="form-group">
                                <label class="form-label">Berat Kotor (kg) *</label>
                                <div class="input-group">
                                    <input type="number" class="form-input" id="f-bruto" step="0.01" onchange="hitung()" required>
                                    <span class="input-suffix">kg</span>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Tara (kg) *</label>
                                <div class="input-group">
                                    <input type="number" class="form-input" id="f-tara" step="0.01" onchange="hitung()" required>
                                    <span class="input-suffix">kg</span>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Potongan (%)</label>
                                <div class="input-group">
                                    <input type="number" class="form-input" id="f-potongan" value="0" step="0.01" onchange="hitung()">
                                    <span class="input-suffix">%</span>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Berat Bersih</label>
                                <div class="input-group">
                                    <input type="text" class="form-input" id="f-netto" readonly style="font-weight:700;color:var(--primary)">
                                    <span class="input-suffix">kg</span>
                                </div>
                            </div>
                        </div>

                        <h4 style="margin:1rem 0 0.5rem;font-size:0.875rem;color:#64748b">üí∞ Detail Keuangan</h4>
                        <div class="form-grid">
                            <div class="form-group">
                                <label class="form-label">Harga/kg *</label>
                                <div class="input-group">
                                    <span class="input-prefix">Rp</span>
                                    <input type="number" class="form-input" id="f-harga" onchange="hitung()" required>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Biaya Admin</label>
                                <div class="input-group">
                                    <span class="input-prefix">Rp</span>
                                    <input type="number" class="form-input" id="f-admin" value="0" onchange="hitung()">
                                </div>
                            </div>
                        </div>

                        <div class="calc-box">
                            <div class="calc-row"><span>Subtotal:</span><span>Rp <span id="c-subtotal">0</span></span></div>
                            <div class="calc-row"><span>Biaya Admin:</span><span>Rp <span id="c-admin">0</span></span></div>
                            <div class="calc-row"><span>Total Transfer:</span><span>Rp <span id="c-total">0</span></span></div>
                        </div>

                        <h4 style="margin:1rem 0 0.5rem;font-size:0.875rem;color:#64748b">üí≥ Pembayaran</h4>
                        <div class="form-grid">
                            <div class="form-group">
                                <label class="form-label">Status</label>
                                <select class="form-select" id="f-status" onchange="hitung()">
                                    <option value="Lunas">‚úÖ Lunas</option>
                                    <option value="Dicicil">‚è≥ Dicicil</option>
                                    <option value="Belum Lunas">‚ùå Belum Lunas</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Sisa/Terutang</label>
                                <div class="input-group">
                                    <span class="input-prefix">Rp</span>
                                    <input type="text" class="form-input" id="f-sisa" readonly>
                                </div>
                            </div>
                        </div>

                        <div style="display:flex;gap:0.5rem;margin-top:1rem">
                            <button type="submit" class="btn btn-primary" style="flex:1">üíæ Simpan</button>
                            <button type="button" class="btn btn-outline" onclick="resetForm()">‚ùå Batal</button>
                        </div>
                    </div>
                </div>
            </form>
        </section>

        <!-- Riwayat -->
        <section id="riwayat" class="tab-content" style="display:none">
            <div class="card">
                <div class="card-header">
                    <h3>üìã Riwayat Transaksi</h3>
                    <button class="btn btn-success" onclick="exportCSV()">üì• Export</button>
                </div>
                <div class="card-body">
                    <div style="display:flex;gap:0.5rem;margin-bottom:1rem;overflow-x:auto">
                        <input type="text" class="form-input" id="s-search" placeholder="üîç Cari..." onkeyup="loadRiwayat()" style="flex:1;min-width:150px">
                        <select class="form-select" id="s-status" onchange="loadRiwayat()" style="width:120px">
                            <option value="">Semua</option>
                            <option value="Lunas">Lunas</option>
                            <option value="Dicicil">Dicicil</option>
                            <option value="Belum Lunas">Belum Lunas</option>
                        </select>
                        <input type="date" class="form-input" id="s-tgl" onchange="loadRiwayat()" style="width:140px">
                    </div>
                    <div class="table-container">
                        <table id="t-riwayat">
                            <thead>
                                <tr><th>Tanggal</th><th>Supir</th><th>Plat</th><th>Supplier</th><th>Berat</th><th>Total</th><th>Status</th><th>Aksi</th></tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </section>

        <!-- Data -->
        <section id="data" class="tab-content" style="display:none">
            <div class="card">
                <div class="card-header"><h3>üìÅ Import CSV</h3></div>
                <div class="card-body">
                    <div class="upload-zone" onclick="document.getElementById('file-csv').click()">
                        <div style="font-size:3rem;margin-bottom:0.5rem">üì§</div>
                        <p>Tap untuk upload file CSV</p>
                        <small style="color:#94a3b8">Format: tanggal,jam,supir,plat,supplier,bruto,tara,potongan,harga,admin,status</small>
                    </div>
                    <input type="file" id="file-csv" accept=".csv" style="display:none" onchange="importCSV(this)">
                    <div style="margin-top:1rem">
                        <button class="btn btn-secondary" onclick="downloadTemplate()">üìÑ Template</button>
                    </div>
                </div>
            </div>
            
            <div class="card">
                <div class="card-header"><h3>üíæ Backup & Restore</h3></div>
                <div class="card-body" style="display:flex;gap:1rem;flex-wrap:wrap">
                    <div>
                        <button class="btn btn-success" onclick="backupJSON()">üíæ Backup JSON</button>
                    </div>
                    <div>
                        <input type="file" id="file-json" accept=".json" style="display:none" onchange="restoreJSON(this)">
                        <button class="btn btn-warning" onclick="document.getElementById('file-json').click()">üîÑ Restore</button>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- Modal Nota -->
    <div class="modal" id="modal-nota" onclick="if(event.target===this)closeNota()">
        <div class="modal-content">
            <div class="modal-header no-print">
                <h3>üßæ Nota Timbangan</h3>
                <button class="btn btn-outline" onclick="closeNota()">‚úï</button>
            </div>
            <div class="modal-body">
                <div class="nota" id="nota-print">
                    <div class="nota-header">
                        <div class="nota-title">TIMBANGAN GAS JAYA</div>
                        <div style="font-size:10px">Jl. Industri No. 123, Jakarta</div>
                    </div>
                    <div class="nota-row"><span>No:</span><span id="n-no">-</span></div>
                    <div class="nota-row"><span>Tgl:</span><span id="n-tgl">-</span></div>
                    <div class="nota-row"><span>Supir:</span><span id="n-supir">-</span></div>
                    <div class="nota-row"><span>Plat:</span><span id="n-plat">-</span></div>
                    <div style="border-top:1px dashed #000;margin:0.5rem 0"></div>
                    <div class="nota-row"><span>Bruto:</span><span id="n-bruto">-</span></div>
                    <div class="nota-row"><span>Tara:</span><span id="n-tara">-</span></div>
                    <div class="nota-row"><span>Netto:</span><span id="n-netto" style="font-weight:bold">-</span></div>
                    <div style="border-top:1px dashed #000;margin:0.5rem 0"></div>
                    <div class="nota-total"><span>TOTAL:</span><span id="n-total">-</span></div>
                    <div class="nota-row"><span>Status:</span><span id="n-status">-</span></div>
                    <div style="margin-top:2rem;display:flex;justify-content:space-between;font-size:10px">
                        <div style="text-align:center;width:40%"><div style="border-top:1px solid #000;margin-top:2rem">Operator</div></div>
                        <div style="text-align:center;width:40%"><div style="border-top:1px solid #000;margin-top:2rem">Supir</div></div>
                    </div>
                </div>
            </div>
            <div class="modal-footer no-print">
                <button class="btn btn-outline" onclick="closeNota()">Tutup</button>
                <button class="btn btn-primary" onclick="window.print()">üñ®Ô∏è Cetak</button>
            </div>
        </div>
    </div>

    <script>
        // Data storage
        const DB={key:'gasjaya_v1',get:()=>JSON.parse(localStorage.getItem(this.key)||'[]'),set:(d)=>localStorage.setItem(this.key,JSON.stringify(d))};
        let data=DB.get();
        
        // Init
        document.addEventListener('DOMContentLoaded',()=>{
            init();
            window.addEventListener('online',()=>updateOnline(true));
            window.addEventListener('offline',()=>updateOnline(false));
            if(!navigator.onLine)updateOnline(false);
        });
        
        function init(){
            const now=new Date();
            document.getElementById('f-tgl').value=now.toISOString().split('T')[0];
            document.getElementById('f-jam').value=now.toTimeString().slice(0,5);
            updateStats();
            loadRecent();
            loadRiwayat();
        }
        
        function updateOnline(isOnline){
            const el=document.getElementById('status');
            const off=document.getElementById('offline');
            if(isOnline){
                el.innerHTML='üü¢ Online';
                off.classList.remove('show');
                showToast('Koneksi kembali');
            }else{
                el.innerHTML='üü† Offline';
                off.classList.add('show');
                showToast('Anda offline - data tersimpan lokal','warning');
            }
        }
        
        function showToast(msg,type='success'){
            const t=document.getElementById('toast');
            t.textContent=(type==='success'?'‚úÖ ':'‚ö†Ô∏è ')+msg;
            t.className='toast show';
            setTimeout(()=>t.classList.remove('show'),3000);
        }
        
        function switchTab(tab){
            document.querySelectorAll('.tab-content').forEach(e=>e.style.display='none');
            document.getElementById(tab).style.display='block';
            document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active'));
            event.target.classList.add('active');
            if(tab==='riwayat')loadRiwayat();
        }
        
        function hitung(){
            const bruto=parseFloat(document.getElementById('f-bruto').value)||0;
            const tara=parseFloat(document.getElementById('f-tara').value)||0;
            const potongan=parseFloat(document.getElementById('f-potongan').value)||0;
            const harga=parseFloat(document.getElementById('f-harga').value)||0;
            const admin=parseFloat(document.getElementById('f-admin').value)||0;
            
            const hasil=bruto-tara;
            const netto=hasil-((hasil*potongan)/100);
            const subtotal=netto*harga;
            const total=subtotal+admin;
            
            document.getElementById('f-netto').value=netto.toFixed(2);
            document.getElementById('c-subtotal').textContent=formatRupiah(subtotal);
            document.getElementById('c-admin').textContent=formatRupiah(admin);
            document.getElementById('c-total').textContent=formatRupiah(total);
            
            const status=document.getElementById('f-status').value;
            const sisa=status==='Lunas'?0:(status==='Belum Lunas'?total:0);
            document.getElementById('f-sisa').value=formatRupiah(sisa);
        }
        
        function saveData(e){
            e.preventDefault();
            const trans={
                id:Date.now(),
                tanggal:document.getElementById('f-tgl').value,
                jam:document.getElementById('f-jam').value,
                supir:document.getElementById('f-supir').value,
                plat:document.getElementById('f-plat').value,
                supplier:document.getElementById('f-supplier').value,
                bruto:parseFloat(document.getElementById('f-bruto').value)||0,
                tara:parseFloat(document.getElementById('f-tara').value)||0,
                potongan:parseFloat(document.getElementById('f-potongan').value)||0,
                netto:parseFloat(document.getElementById('f-netto').value)||0,
                harga:parseFloat(document.getElementById('f-harga').value)||0,
                admin:parseFloat(document.getElementById('f-admin').value)||0,
                total:parseInt(document.getElementById('c-total').textContent.replace(/\D/g,''))||0,
                status:document.getElementById('f-status').value,
                sisa:parseInt(document.getElementById('f-sisa').value.replace(/\D/g,''))||0
            };
            
            data.unshift(trans);
            DB.set(data);
            showToast('Transaksi tersimpan!');
            updateStats();
            loadRecent();
            
            if(confirm('Cetak nota sekarang?'))showNota(trans.id);
            else resetForm();
        }
        
        function resetForm(){
            document.querySelector('form').reset();
            init();
            hitung();
        }
        
        function updateStats(){
            document.getElementById('stat-total').textContent=data.length;
            document.getElementById('stat-berat').textContent=data.reduce((a,b)=>a+b.netto,0).toFixed(2);
            document.getElementById('stat-nilai').textContent=(data.reduce((a,b)=>a+b.total,0)/1000000).toFixed(1)+'M';
            document.getElementById('stat-pending').textContent=data.filter(t=>t.status!=='Lunas').length;
        }
        
        function loadRecent(){
            const el=document.getElementById('recent-list');
            const recent=data.slice(0,5);
            if(!recent.length){el.innerHTML='<div class="empty">Belum ada transaksi</div>';return;}
            el.innerHTML=recent.map(t=>`
                <div style="display:flex;align-items:center;gap:0.75rem;padding:0.75rem;background:#f8fafc;border-radius:0.5rem;margin-bottom:0.5rem;cursor:pointer" onclick="showNota(${t.id})">
                    <div style="width:40px;height:40px;background:#fff;border-radius:0.5rem;display:flex;align-items:center;justify-content:center;font-size:1.25rem">${t.status==='Lunas'?'‚úÖ':'‚è≥'}</div>
                    <div style="flex:1">
                        <div style="font-weight:600">${t.supir} - ${t.plat}</div>
                        <div style="font-size:0.75rem;color:#64748b">${formatTgl(t.tanggal)} ‚Ä¢ ${t.supplier}</div>
                    </div>
                    <div style="text-align:right">
                        <div style="font-weight:600">Rp ${formatRupiah(t.total)}</div>
                        <div style="font-size:0.75rem;color:#64748b">${t.netto} kg</div>
                    </div>
                </div>
            `).join('');
        }
        
        function loadRiwayat(){
            const tbody=document.querySelector('#t-riwayat tbody');
            const search=document.getElementById('s-search').value.toLowerCase();
            const status=document.getElementById('s-status').value;
            const tgl=document.getElementById('s-tgl').value;
            
            let filtered=data.filter(t=>{
                const m=!search||[t.supir,t.plat,t.supplier].some(x=>x&&x.toLowerCase().includes(search));
                const s=!status||t.status===status;
                const tg=!tgl||t.tanggal===tgl;
                return m&&s&&tg;
            });
            
            if(!filtered.length){tbody.innerHTML='<tr><td colspan="8" style="text-align:center;padding:2rem">Tidak ada data</td></tr>';return;}
            
            tbody.innerHTML=filtered.map(t=>{
                const badge=t.status==='Lunas'?'badge-success':(t.status==='Dicicil'?'badge-warning':'badge-danger');
                return`<tr>
                    <td>${formatTgl(t.tanggal)}<br><small>${t.jam}</small></td>
                    <td>${esc(t.supir)}</td>
                    <td>${esc(t.plat)}</td>
                    <td>${esc(t.supplier)}</td>
                    <td>${t.netto.toFixed(2)} kg</td>
                    <td>Rp ${formatRupiah(t.total)}</td>
                    <td><span class="badge ${badge}">${t.status}</span></td>
                    <td class="no-print">
                        <button class="btn btn-primary btn-sm" onclick="event.stopPropagation();showNota(${t.id})" style="padding:0.25rem 0.5rem">üñ®Ô∏è</button>
                        <button class="btn btn-danger btn-sm" onclick="event.stopPropagation();deleteTrans(${t.id})" style="padding:0.25rem 0.5rem">üóëÔ∏è</button>
                    </td>
                </tr>`;
            }).join('');
        }
        
        function deleteTrans(id){
            if(!confirm('Hapus transaksi ini?'))return;
            data=data.filter(t=>t.id!==id);
            DB.set(data);
            updateStats();
            loadRecent();
            loadRiwayat();
            showToast('Transaksi dihapus');
        }
        
        function showNota(id){
            const t=data.find(x=>x.id===id);
            if(!t)return;
            document.getElementById('n-no').textContent='TRX-'+String(t.id).slice(-6);
            document.getElementById('n-tgl').textContent=formatTgl(t.tanggal)+' '+t.jam;
            document.getElementById('n-supir').textContent=t.supir;
            document.getElementById('n-plat').textContent=t.plat;
            document.getElementById('n-bruto').textContent=t.bruto.toFixed(2)+' kg';
            document.getElementById('n-tara').textContent=t.tara.toFixed(2)+' kg';
            document.getElementById('n-netto').textContent=t.netto.toFixed(2)+' kg';
            document.getElementById('n-total').textContent='Rp '+formatRupiah(t.total);
            document.getElementById('n-status').textContent=t.status;
            document.getElementById('modal-nota').classList.add('show');
        }
        
        function closeNota(){document.getElementById('modal-nota').classList.remove('show')}
        
        function exportCSV(){
            if(!data.length){showToast('Tidak ada data!','warning');return;}
            const csv=Papa.unparse(data);
            download(csv,`transaksi_${new Date().toISOString().split('T')[0]}.csv`,'text/csv');
            showToast('CSV diunduh!');
        }
        
        function importCSV(input){
            const file=input.files[0];
            Papa.parse(file,{header:true,complete:r=>{
                const imported=r.data.filter(x=>x.supir).map(x=>({
                    id:Date.now()+Math.random(),...x,
                    bruto:parseFloat(x.bruto)||0,tara:parseFloat(x.tara)||0,
                    potongan:parseFloat(x.potongan)||0,harga:parseFloat(x.harga)||0,
                    admin:parseFloat(x.admin)||0,
                    netto:(parseFloat(x.bruto)-parseFloat(x.tara))-(((parseFloat(x.bruto)-parseFloat(x.tara))*parseFloat(x.potongan))/100,
                    total:((parseFloat(x.bruto)-parseFloat(x.tara)-(((parseFloat(x.bruto)-parseFloat(x.tara))*parseFloat(x.potongan))/100)*parseFloat(x.harga))+parseFloat(x.admin)
                }));
                data=[...imported,...data];
                DB.set(data);
                updateStats();
                loadRecent();
                loadRiwayat();
                showToast(`Import ${imported.length} data berhasil!`);
                input.value='';
            }});
        }
        
        function downloadTemplate(){
            const csv='tanggal,jam,supir,plat,supplier,bruto,tara,potongan,harga,admin,status\n2024-01-15,08:30,Budi Santono,B 1234 ABC,PT Gas Makmur,5000,1500,2,8500,50000,Lunas\n';
            download(csv,'template.csv','text/csv');
            showToast('Template diunduh!');
        }
        
        function backupJSON(){
            download(JSON.stringify(data,null,2),`backup_${new Date().toISOString().split('T')[0]}.json`,'application/json');
            showToast('Backup dibuat!');
        }
        
        function restoreJSON(input){
            const file=input.files[0];
            const reader=new FileReader();
            reader.onload=e=>{
                try{
                    const restored=JSON.parse(e.target.result);
                    if(Array.isArray(restored)&&confirm(`Restore ${restored.length} transaksi?`)){
                        data=[...restored,...data];
                        DB.set(data);
                        updateStats();
                        loadRecent();
                        loadRiwayat();
                        showToast('Restore berhasil!');
                    }
                }catch(err){showToast('File tidak valid!','error')}
            };
            reader.readAsText(file);
            input.value='';
        }
        
        function download(content,filename,type){
            const blob=new Blob([content],{type});
            const url=URL.createObjectURL(blob);
            const a=document.createElement('a');
            a.href=url;a.download=filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
        
        function formatRupiah(n){return new Intl.NumberFormat('id-ID').format(n)}
        function formatTgl(d){return new Date(d).toLocaleDateString('id-ID',{day:'2-digit',month:'short',year:'numeric'})}
        function esc(t){const d=document.createElement('div');d.textContent=t||'';return d.innerHTML}
    </script>
</body>
</html>
